<div *ngIf="project$ | async as project; else loading" class="p-4 sm:p-6 lg:p-8">

  <div class="pb-5 mb-8 border-b border-gray-200 dark:border-primary-light/10">
    <h3 class="text-2xl font-bold leading-6 text-text-main dark:text-gray-100">{{ project.name }}</h3>
    <p class="max-w-4xl mt-2 text-sm text-text-secondary dark:text-gray-400">{{ project.description }}</p>
    <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">Owner: {{ project.owner.email }}</p>
  </div>

  <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">
    <div class="lg:col-span-9">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-xl font-semibold text-text-main dark:text-gray-200">Tasks</h4>
        <button (click)="showCreateTaskForm = !showCreateTaskForm" class="px-3 py-1 text-sm font-medium text-white transition-colors rounded-md bg-primary hover:bg-primary-dark">{{ showCreateTaskForm ? 'Cancel' : '+ New Task' }}</button>
      </div>

      <form *ngIf="showCreateTaskForm" [formGroup]="taskForm" (ngSubmit)="onTaskCreateSubmit()" class="p-4 mb-6 space-y-4 shadow-sm bg-background-light dark:bg-primary-dark rounded-lg">
        <div>
            <label for="title" class="sr-only">Title</label>
            <input id="title" type="text" formControlName="title" placeholder="Task title" class="block w-full px-3 py-2 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md shadow-sm text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary">
        </div>
        <div>
            <label for="description" class="sr-only">Description</label>
            <textarea id="description" formControlName="description" placeholder="Task description" rows="3" class="block w-full px-3 py-2 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md shadow-sm text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary"></textarea>
        </div>
        <div>
            <label for="difficulty" class="sr-only">Difficulty</label>
            <select id="difficulty" formControlName="difficulty" class="block w-full px-3 py-2 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md shadow-sm text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary">
              <option *ngFor="let difficulty of taskDifficulties" [value]="difficulty">{{ difficulty | titlecase }}</option>
            </select>
        </div>
        <div>
          <label for="dependencies-create" class="block text-sm font-medium text-text-secondary dark:text-gray-300">Depends on</label>
          <select 
              id="dependencies-create"
              multiple
              formControlName="dependencyIds"
              class="block w-full h-24 px-3 py-2 mt-1 bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md shadow-sm text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary"
          >
              <option *ngFor="let task of (allTasksInProject$ | async)" [value]="task.id">{{ task.title }}</option>
          </select>
          <p class="mt-1 text-xs text-gray-500">Hold Ctrl (or Cmd on Mac) to select multiple tasks.</p>
        </div>
        <button type="submit" [disabled]="taskForm.invalid" class="px-4 py-2 text-sm font-medium text-white transition-colors border border-transparent rounded-md shadow-sm bg-primary hover:bg-primary-dark disabled:bg-primary-light">Add Task</button>
      </form>

      <div cdkDropListGroup class="grid grid-cols-1 gap-6 md:grid-cols-3">
        
        <div 
          id="to_do"
          cdkDropList
          [cdkDropListData]="(todoTasks$ | async) || []"
          [cdkDropListConnectedTo]="['in_progress']"
          (cdkDropListDropped)="onTaskDrop($event)"
          class="p-4 rounded-lg bg-background-light dark:bg-primary-dark/50"
        >
          <h3 class="font-bold text-text-main dark:text-gray-200">To Do</h3>
          <div class="mt-4 space-y-4 min-h-[100px]">
            <ng-container *ngIf="(todoTasks$ | async) as tasks">
              <div *ngFor="let task of tasks; trackBy: trackByTaskId" cdkDrag [cdkDragData]="task" class="p-4 bg-white dark:bg-primary-dark rounded-lg shadow-sm cursor-pointer hover:ring-2 hover:ring-accent" (click)="openTaskDetails(task)">
                <div class="flex items-center space-x-2">
                  <p class="font-semibold text-text-main dark:text-gray-200">{{ task.title }}</p>
                  <span *ngIf="hasUnmetDependencies(task)" title="This task is blocked by other tasks">üîí</span>
                </div>
                <div class="flex items-center justify-between mt-2">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full text-accent-dark dark:text-yellow-200 bg-accent/20 dark:bg-yellow-900/50">{{ task.difficulty | titlecase }} | {{task.xpValue}} XP</span>
                  <div class="flex items-center space-x-2">
                    <!-- <button (click)="onCompleteTask(task.id); $event.stopPropagation()" class="px-3 py-1 text-xs font-medium text-white transition-colors rounded-md bg-accent hover:bg-accent-dark" title="Complete Task">‚úì</button> -->
                    <button (click)="onDeleteTask(task.id, task.title); $event.stopPropagation()" class="text-gray-400 hover:text-red-500" title="Delete Task">üóëÔ∏è</button>
                  </div>
                </div>

                <div class="mt-4 pt-4 border-t dark:border-gray-700">
                  <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Comments</h4>
                  <div class="mt-2 space-y-3">
                    <div *ngFor="let comment of task.comments" class="text-sm">
                      <p class="font-semibold text-text-secondary dark:text-gray-300">{{ comment.author.username }} <span class="ml-2 text-xs font-normal text-gray-400 dark:text-gray-500">{{ comment.createdAt | date:'short' }}</span></p>
                      <p class="text-gray-700 dark:text-gray-200">{{ comment.content }}</p>
                    </div>
                    <p *ngIf="!task.comments || task.comments.length === 0" class="text-xs text-gray-400">No comments yet.</p>
                  </div>
                  <form [formGroup]="commentForm" (ngSubmit)="onCommentSubmit(task.id); $event.stopPropagation()" (click)="$event.stopPropagation()" class="flex items-start mt-4 space-x-2">
                    <textarea formControlName="content" rows="1" placeholder="Add a comment..." class="block w-full px-2 py-1 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary"></textarea>
                    <button type="submit" [disabled]="commentForm.invalid" class="px-3 py-1 text-sm font-medium text-white rounded-md bg-primary hover:bg-primary-dark disabled:bg-primary-light">Post</button>
                  </form>
                </div>
              </div>
              <p *ngIf="tasks.length === 0" class="text-xs text-center text-gray-500 dark:text-gray-400">No tasks here.</p>
            </ng-container>
          </div>
        </div>

        <div 
          id="in_progress"
          cdkDropList
          [cdkDropListData]="(inProgressTasks$ | async) || []"
          [cdkDropListConnectedTo]="['to_do']"
          (cdkDropListDropped)="onTaskDrop($event)"
          class="p-4 rounded-lg bg-background-light dark:bg-primary-dark/50"
        >
          <h3 class="font-bold text-text-main dark:text-gray-200">In Progress</h3>
          <div class="mt-4 space-y-4 min-h-[100px]">
            <ng-container *ngIf="(inProgressTasks$ | async) as tasks">
              <div *ngFor="let task of tasks; trackBy: trackByTaskId" cdkDrag [cdkDragData]="task" (click)="openTaskDetails(task)" class="p-4 bg-white dark:bg-primary-dark rounded-lg shadow-sm cursor-pointer hover:ring-2 hover:ring-accent">
                <div class="flex items-center space-x-2">
                  <p class="font-semibold text-text-main dark:text-gray-200">{{ task.title }}</p>
                  <span *ngIf="hasUnmetDependencies(task)" title="This task is blocked by other tasks">üîí</span>
                </div>
                <div class="flex items-center justify-between mt-2">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full text-accent-dark dark:text-yellow-200 bg-accent/20 dark:bg-yellow-900/50">{{ task.difficulty | titlecase }} | {{task.xpValue}} XP</span>
                  <div class="flex items-center space-x-2">
                    <button (click)="onCompleteTask(task.id); $event.stopPropagation()" class="px-3 py-1 text-xs font-medium text-white transition-colors rounded-md bg-accent hover:bg-accent-dark" title="Complete Task">‚úì</button>
                    <button (click)="onDeleteTask(task.id, task.title); $event.stopPropagation()" class="text-gray-400 hover:text-red-500" title="Delete Task">üóëÔ∏è</button>
                  </div>
                </div>
                <div class="mt-4 pt-4 border-t dark:border-gray-700">
                  <h4 class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Comments</h4>
                  <div class="mt-2 space-y-3">
                     <div *ngFor="let comment of task.comments" class="text-sm">
                      <p class="font-semibold text-text-secondary dark:text-gray-300">{{ comment.author.username }} <span class="ml-2 text-xs font-normal text-gray-400 dark:text-gray-500">{{ comment.createdAt | date:'short' }}</span></p>
                      <p class="text-gray-700 dark:text-gray-200">{{ comment.content }}</p>
                    </div>
                    <p *ngIf="!task.comments || task.comments.length === 0" class="text-xs text-gray-400">No comments yet.</p>
                  </div>
                  <form [formGroup]="commentForm" (ngSubmit)="onCommentSubmit(task.id); $event.stopPropagation()" (click)="$event.stopPropagation()" class="flex items-start mt-4 space-x-2">
                    <textarea formControlName="content" rows="1" placeholder="Add a comment..." class="block w-full px-2 py-1 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary"></textarea>
                    <button type="submit" [disabled]="commentForm.invalid" class="px-3 py-1 text-sm font-medium text-white rounded-md bg-primary hover:bg-primary-dark disabled:bg-primary-light">Post</button>
                  </form>
                </div>
              </div>
              <p *ngIf="tasks.length === 0" class="text-xs text-center text-gray-500 dark:text-gray-400">No tasks here.</p>
            </ng-container>
          </div>
        </div>

        <div 
          id="done"
          cdkDropList
          [cdkDropListData]="(doneTasks$ | async) || []"
          class="p-4 rounded-lg bg-background-light dark:bg-primary-dark/50"
        >
          <h3 class="font-bold text-text-main dark:text-gray-200">Done</h3>
          <div class="mt-4 space-y-4 min-h-[100px]">
            <ng-container *ngIf="(doneTasks$ | async) as tasks">
              <div *ngFor="let task of tasks; trackBy: trackByTaskId" (click)="openTaskDetails(task)" class="p-4 bg-white dark:bg-primary-dark rounded-lg shadow-sm opacity-70">
                <p class="font-semibold text-gray-800 dark:text-gray-400 line-through">{{ task.title }}</p>
                <div class="flex items-center justify-between mt-2">
                  <span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full">{{ task.difficulty | titlecase }} | {{task.xpValue}} XP</span>
                  <button (click)="onDeleteTask(task.id, task.title); $event.stopPropagation()" class="text-gray-400 hover:text-red-500" title="Delete Task">üóëÔ∏è</button>
                </div>
              </div>
              <p *ngIf="tasks.length === 0" class="text-xs text-center text-gray-500 dark:text-gray-400">No tasks here.</p>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="lg:col-span-3">
      <h4 class="text-lg font-medium text-text-main dark:text-gray-100">Members</h4>
      <div *ngIf="(currentUser$ | async) as currentUser" class="my-4">
        <div *ngIf="project && project.owner && currentUser?.id === project.owner.id">
          <form [formGroup]="addMemberForm" (ngSubmit)="onAddMemberSubmit()">
            <label for="member-email" class="sr-only">Member Email</label>
            <div class="flex items-center gap-2">
              <input 
                id="member-email" 
                type="email" 
                formControlName="email" 
                placeholder="Enter member's email"
                class="block w-full px-3 py-2 text-sm bg-white dark:bg-primary-light/10 border-gray-300 dark:border-primary-light/20 rounded-md shadow-sm text-text-main dark:text-gray-200 focus:ring-primary focus:border-primary"
              >
              <button 
                type="submit" 
                [disabled]="addMemberForm.invalid" 
                class="p-2 text-white rounded-md bg-primary hover:bg-primary-dark disabled:bg-primary-light"
                title="Add Member"
              >
                +
              </button>
            </div>
          </form>
          <div *ngIf="addMemberSuccessMessage" class="p-3 mt-2 text-sm text-green-800 bg-green-100 rounded-lg">
            {{ addMemberSuccessMessage }}
          </div>
          <div *ngIf="addMemberErrorMessage" class="p-3 mt-2 text-sm text-red-800 bg-red-100 rounded-lg">
            {{ addMemberErrorMessage }}
          </div>
        </div>
      </div>
      <ul *ngIf="project && project.members && project.members.length > 0" class="mt-4 space-y-2">
        <li *ngFor="let member of project.members" class="flex items-center justify-between p-2 rounded-md bg-background-light dark:bg-primary-dark">
          <span class="text-sm font-medium text-text-main dark:text-gray-200">{{ member.email }}</span>
          <span *ngIf="member.id === project.owner.id" class="px-2 text-xs rounded-full text-primary-dark bg-primary/20 dark:text-accent-light dark:bg-accent/20">Owner</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<ng-template #loading>
  <p class="p-4 text-center text-text-secondary dark:text-gray-400">Loading project details...</p>
</ng-template>

<app-task-detail-modal 
  *ngIf="selectedTaskForDetails" 
  [task]="selectedTaskForDetails"
  [potentialDependencies]="potentialDependencies"
  (close)="closeTaskDetails()"
  (saveDependencies)="onSaveDependencies($event)"
/>